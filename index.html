<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

  const SUPABASE_URL = 'https://pwsgygqzxyzaxghyggme.supabase.co';
  const SUPABASE_ANON_KEY = 'sb_publishable_oPBMZmrWLCFSxJqOaC8Lrw_78C8iLrt';

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const players = ['Gina', 'Anders', 'Kaylee', 'Philip', 'Rosie', 'Anfern'];
  const statusEl = document.getElementById('status');
  const form = document.getElementById('recordForm');
  const recordsTbody = document.querySelector('#recordsTable tbody');

  let allRecords = [];

  async function loadRecords() {
    const { data, error } = await supabase
      .from('records')
      .select('*')
      .order('created_at', { ascending: false });

    if (error) {
      statusEl.textContent = 'üî¥ Error loading data';
      statusEl.className = 'status offline';
      console.error(error);
      return;
    }

    allRecords = data || [];
    updateTables(allRecords);
    statusEl.textContent = `üü¢ Online ‚Äî ${allRecords.length} records`;
    statusEl.className = 'status connected';
  }

  // Instant real-time updates
  const channel = supabase.channel('public:records')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'records' }, () => {
      loadRecords();
    })
    .subscribe((status) => {
      if (status === 'SUBSCRIBED') loadRecords();
    });

  async function addRecord() {
    const date = document.getElementById('dateInput').value;
    const playerText = document.getElementById('playerSelect').value.trim();
    const player = playerText.split(' ')[0];
    const amountStr = document.getElementById('amountInput').value.trim();

    if (!date || !amountStr) return alert('Ë´ãÂ°´Êó•ÊúüÂíåÈáëÈ°ç');
    const amount = parseFloat(amountStr);
    if (isNaN(amount) || amount === 0) return alert('Ë´ãËº∏ÂÖ•ÊúâÊïàÈáëÈ°ç');

    const win = amount > 0 ? Math.abs(amount) : 0;
    const lose = amount < 0 ? Math.abs(amount) : 0;

    statusEl.textContent = 'üü† Adding...';
    statusEl.className = 'status syncing';

    const { error } = await supabase
      .from('records')
      .insert({
        date,
        player,
        win,
        lose,
        player_display: playerText
      });

    if (error) {
      alert('Add failed');
      console.error(error);
    }

    document.getElementById('amountInput').value = '';
  }

  recordsTbody.addEventListener('click', async (e) => {
    if (!e.target.classList.contains('delete-btn')) return;

    const recordId = e.target.dataset.id;
    if (!confirm('Âà™Èô§ÔºüÊâÄÊúâ‰∫∫ÊúÉÁúãÂà∞')) return;

    statusEl.textContent = 'üü† Deleting...';
    statusEl.className = 'status syncing';

    const { error } = await supabase
      .from('records')
      .delete()
      .eq('id', recordId);

    if (error) {
      alert('Delete failed');
      console.error(error);
    }
  });

  form.addEventListener('submit', (e) => {
    e.preventDefault();
    addRecord();
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && e.target.id === 'amountInput') {
      e.preventDefault();
      addRecord();
    }
  });

  function updateTables(records) {
    recordsTbody.innerHTML = records.slice(0, 50).map(r => `
      <tr>
        <td>${r.date}</td>
        <td>${r.player_display}</td>
        <td>$${Number(r.win).toLocaleString()}</td>
        <td>$${Number(r.lose).toLocaleString()}</td>
        <td class="${r.net > 0 ? 'positive' : 'negative'}">${r.net > 0 ? '+' : ''}$${Math.abs(r.net).toLocaleString()}</td>
        <td><button class="delete-btn" data-id="${r.id}">üóëÔ∏è</button></td>
      </tr>
    `).join('');

    const totals = {};
    players.forEach(p => totals[p] = {win:0, lose:0});
    records.forEach(r => {
      totals[r.player].win += Number(r.win || 0);
      totals[r.player].lose += Number(r.lose || 0);
    });

    const tbody2 = document.querySelector('#totalsTable tbody');
    tbody2.innerHTML = players.map(p => {
      const net = totals[p].win - totals[p].lose;
      return `<tr class="${net > 0 ? 'positive' : net < 0 ? 'negative' : ''}">
        <td><strong>${p}</strong></td>
        <td>$${totals[p].win.toLocaleString()}</td>
        <td>$${totals[p].lose.toLocaleString()}</td>
        <td><strong>${net>0?'+' : ''}$${Math.abs(net).toLocaleString()}</strong></td>
      </tr>`;
    }).join('');
  }

  window.addEventListener('beforeunload', () => supabase.removeChannel(channel));
</script>
