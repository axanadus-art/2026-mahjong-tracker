<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>2026 Mahjong Tracker</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Nunito', sans-serif; background: linear-gradient(135deg, #FCE1F3 0%, #D7E9FF 50%, #CDEAC0 100%); min-height: 100vh; padding: 20px; }
    .container { max-width: 1200px; margin: 0 auto; }
    h1 { text-align: center; color: #FF8AB3; font-size: 2.5em; margin-bottom: 10px; }
    .input-card { background: white; border-radius: 20px; padding: 30px; margin-bottom: 30px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); display: flex; flex-wrap: wrap; gap: 15px; align-items: center; justify-content: center; }
    select, input[type="number"], input[type="date"] { padding: 12px 15px; border: 3px solid #BDE0FE; border-radius: 12px; font-size: 16px; font-family: inherit; min-width: 140px; opacity: 0.6; cursor: not-allowed; }
    button { 
      background: linear-gradient(135deg, #FF8AB3, #FFB3D1); 
      color: white; 
      border: none; 
      padding: 15px 30px; 
      border-radius: 25px; 
      font-size: 18px; 
      font-weight: 700; 
      cursor: not-allowed; 
      opacity: 0.5; 
    }
    .stats-card { background: white; border-radius: 20px; padding: 30px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); overflow-x: auto; margin-bottom: 30px; }
    table { width: 100%; border-collapse: collapse; min-width: 600px; }
    th { background: #FF8AB3; color: white; padding: 15px; text-align: center; font-weight: 700; }
    td { padding: 15px; text-align: center; border-bottom: 1px solid #eee; }
    .date-cell { text-align: left; font-weight: 700; background: #f0f0f0; min-width: 120px; }
    .positive { background: #CDEAC0 !important; font-weight: 700; }
    .negative { background: #FFB3BA !important; font-weight: 700; }

    /* Compact individual entries */
    #rawRecordsTable { font-size: 14px; }
    #rawRecordsTable th, #rawRecordsTable td { padding: 8px 10px; }
    #rawRecordsTable .action-btns button { 
      padding: 6px 10px; 
      font-size: 14px; 
      margin: 0 3px; 
      font-family: 'Nunito', sans-serif; 
      opacity: 0.5; 
      cursor: not-allowed; 
    }

    .edit-btn { background: #4CAF50; color: white; border: none; border-radius: 8px; }
    .delete-btn { background: #f44336; color: white; border: none; border-radius: 8px; }

    .status { text-align: center; margin: 10px 0; padding: 15px; border-radius: 15px; font-weight: 700; font-size: 16px; }
    .connected { background: linear-gradient(135deg, #CDEAC0, #A5D6A7); color: #2E7D32; }
    .offline { background: #FFF3E0; color: #EF6C00; }
    .syncing { background: #E3F2FD; color: #1976D2; }

    .version { text-align: center; font-size: 14px; color: #666; margin-top: 20px; }

    @media (max-width: 768px) {
      .input-card { flex-direction: column; }
      th, td { padding: 10px; font-size: 14px; }
      input, select { min-width: 100%; }
      #rawRecordsTable th, #rawRecordsTable td { padding: 6px; font-size: 12px; }
    }
  </style>
  <script defer data-domain="mahjong2026.tiiny.site" src="https://analytics.tiiny.site/js/plausible.js"></script>
  <script type="text/javascript" src="https://tiiny.host/ad-script.js"></script>
</head>
<body>
  <div class="container">
    <h1>üé∞ 2026 Mahjong Tracker üé∞</h1>
    <div id="status" class="status offline">üîÑ Connecting to cloud...</div>
    <form id="recordForm" class="input-card">
      <input type="date" id="dateInput" value="2026-01-12">
      <select id="playerSelect">
        <option>Anfern</option>
        <option>Anders</option>
        <option>Gina</option>
        <option>Kaylee</option>
        <option>Marco</option>
        <option>Philip</option>
        <option>Rosie</option>
      </select>
      <input type="number" id="amountInput" placeholder="Amount HKD">
      <button type="submit" id="addButton" disabled>Add ‚ú®</button>
    </form>

    <!-- Player Totals -->
    <div class="stats-card">
      <h3>üí∞ Player Totals</h3>
      <table id="totalsTable">
        <thead>
          <tr>
            <th>Rank</th>
            <th>Player</th>
            <th>Win/Loss</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Daily Win/Loss Grid -->
    <div class="stats-card">
      <h3>üìä Daily Win/Loss</h3>
      <table id="dailyGrid">
        <thead>
          <tr>
            <th>Date</th>
            <th>Anfern</th>
            <th>Anders</th>
            <th>Gina</th>
            <th>Kaylee</th>
            <th>Marco</th>
            <th>Philip</th>
            <th>Rosie</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Individual Entries -->
    <div class="stats-card">
      <h3>üóíÔ∏è Entries</h3>
      <table id="rawRecordsTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Player</th>
            <th>Win/Loss</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <p class="version">Version V5 - Deployed January 12, 2026</p>
  </div>

  <script>
    const PANTRY_ID = '11f511b8-6175-47a6-93b9-923736b27f75';
    const BASKET_NAME = 'records';
    const API_BASE = `https://getpantry.cloud/apiv1/pantry/${PANTRY_ID}/basket/${BASKET_NAME}`;
    const players = ['Anfern', 'Anders', 'Gina', 'Kaylee', 'Marco', 'Philip', 'Rosie'];
    const statusEl = document.getElementById('status');
    const form = document.getElementById('recordForm');
    let allRecords = [];
    let isBusy = false;
    let pollInterval;

    async function loadFromCloud() {
      if (isBusy) return;
      try {
        const res = await fetch(API_BASE);
        if (res.ok) {
          const data = await res.json();
          allRecords = data.records || [];
          allRecords.forEach((r, i) => r.id = r.id || (allRecords.length - i));
          allRecords.sort((a, b) => b.id - a.id);
          updateTables();
          statusEl.textContent = `üü¢ Online ‚Äî ${allRecords.length} records`;
          statusEl.className = 'status connected';
        } else if (res.status === 404) {
          allRecords = [];
          updateTables();
          await saveToCloud();
          statusEl.textContent = 'üü¢ Online ‚Äî Ready';
          statusEl.className = 'status connected';
        }
      } catch (e) {
        allRecords = [];
        updateTables();
        statusEl.textContent = 'üî¥ Offline ‚Äî Try again later';
        statusEl.className = 'status offline';
      }
    }

    async function saveToCloud() {
      try {
        await fetch(API_BASE, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ records: allRecords })
        });
      } catch (e) {
        console.log('Save failed', e);
      }
    }

    function startPolling() {
      if (pollInterval) clearInterval(pollInterval);
      pollInterval = setInterval(loadFromCloud, 20000);
    }

    loadFromCloud();
    startPolling();

    // No add, edit, or delete functionality
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      // Do nothing - addition is disabled
    });

    document.querySelector('#rawRecordsTable tbody').addEventListener('click', (e) => {
      // Do nothing - edit & delete are disabled
    });

    function updateTables() {
      // === Player Totals ===
      const totals = {};
      players.forEach(p => totals[p] = {net: 0});
      allRecords.forEach(r => {
        if (totals[r.player]) {
          totals[r.player].net += Number(r.net);
        }
      });

      const rankedPlayers = players.map(p => ({
        player: p,
        net: totals[p].net
      })).sort((a, b) => b.net - a.net);

      const totalsTbody = document.querySelector('#totalsTable tbody');
      totalsTbody.innerHTML = rankedPlayers.map((p, index) => {
        const netDisplay = p.net >= 0 ? `+$${p.net.toLocaleString()}` : `‚àí$${Math.abs(p.net).toLocaleString()}`;
        return `<tr class="${p.net > 0 ? 'positive' : p.net < 0 ? 'negative' : ''}">
          <td><strong>#${index + 1}</strong></td>
          <td><strong>${p.player}</strong></td>
          <td><strong>${netDisplay}</strong></td>
        </tr>`;
      }).join('');

      // === Daily Win/Loss Grid ===
      const byDate = {};
      allRecords.forEach(r => {
        if (!byDate[r.date]) byDate[r.date] = {};
        if (!byDate[r.date][r.player]) byDate[r.date][r.player] = 0;
        byDate[r.date][r.player] += Number(r.net);
      });

      const dates = Object.keys(byDate).sort((a, b) => b.localeCompare(a));

      const dailyTbody = document.querySelector('#dailyGrid tbody');
      dailyTbody.innerHTML = dates.map(date => {
        let row = `<tr><td class="date-cell">${date}</td>`;
        players.forEach(p => {
          const net = byDate[date][p] || 0;
          const netDisplay = net >= 0 ? `+$${net.toLocaleString()}` : `‚àí$${Math.abs(net).toLocaleString()}`;
          const netClass = net > 0 ? 'positive' : net < 0 ? 'negative' : '';
          row += `<td class="${netClass}"><strong>${netDisplay}</strong></td>`;
        });
        row += `</tr>`;
        return row;
      }).join('');

      // === Individual Entries ===
      const rawTbody = document.querySelector('#rawRecordsTable tbody');
      rawTbody.innerHTML = allRecords.map(r => {
        const netDisplay = r.net >= 0 ? `+$${r.net.toLocaleString()}` : `‚àí$${Math.abs(r.net).toLocaleString()}`;
        const netClass = r.net > 0 ? 'positive' : r.net < 0 ? 'negative' : '';
        return `<tr>
          <td>${r.date}</td>
          <td>${r.playerDisplay}</td>
          <td class="${netClass}"><strong>${netDisplay}</strong></td>
          <td class="action-btns">
            <button class="edit-btn" data-id="${r.id}">Edit</button>
            <button class="delete-btn" data-id="${r.id}">Delete</button>
          </td>
        </tr>`;
      }).join('');
    }
  </script>
</body>
</html>
